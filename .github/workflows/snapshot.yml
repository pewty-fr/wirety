---
name: Snapshot

#############
## In PR, add comment `/snapshot` to trigger this workflow
## Builds all components: agent, server, frontend
## If build succeed, it will add reaction :hooray:
## If build failed, it will add reaction :confused:
#############

on:
  issue_comment:
    types:
      - created
      - edited

jobs:
  helper:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && (github.event.comment.body == '/help')
    steps:
      - name: Update comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            ### Available commands
            Command | Description
            --- | ---
            `/help` | Get Help
            `/snapshot agent` | Build & Push agent
            `/snapshot server` | Build & Push server
            `/snapshot front` | Build & Push frontend
            `/snapshot doc` | Build & Push documentation
            `/snapshot helm` | Build helm chart package
            `/snapshot` | Build & Push all components
  build-helm:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && (github.event.comment.body == '/snapshot helm' || github.event.comment.body == '/snapshot')
    steps:
      - uses: xt0rted/pull-request-comment-branch@v2
        id: comment_branch
      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.comment_branch.outputs.head_ref }}
      - run: |
          echo "date=$(date -u +'%Y-%m-%dT%H-%M-%SZ')" >> "$GITHUB_OUTPUT"
        id: vars
      - uses: azure/setup-helm@v3
        with:
          version: latest
          token: ${{ secrets.GITHUB_TOKEN }} # only needed if version is 'latest'
      - name: Package Helm Chart
        id: package_helm
        run: |
          echo "${{ secrets.SCW_SECRET_KEY }}" | helm registry login rg.fr-par.scw.cloud -u nologin --password-stdin
          helm package ./helm --version v0.0.0-${{ steps.vars.outputs.date }}
          helm push wirety-v0.0.0-${{ steps.vars.outputs.date }}.tgz oci://rg.fr-par.scw.cloud/wirety/chart
      - name: Update comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            **Helm chart package:**
            oci://rg.fr-par.scw.cloud/wirety/chart/wirety:v0.0.0-${{ steps.vars.outputs.date }}
          reactions: hooray
          reactions-edit-mode: replace

  build-agent:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && (github.event.comment.body == '/snapshot agent' || github.event.comment.body == '/snapshot')
    steps:
      - uses: xt0rted/pull-request-comment-branch@v2
        id: comment_branch
      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.comment_branch.outputs.head_ref }}
      - run: |
          echo "date=$(date -u +'%Y-%m-%dT%H-%M-%SZ')" >> "$GITHUB_OUTPUT"
        id: vars
      - uses: actions/setup-go@v5
        with:
          go-version: '>=1.25.0'
      
      - name: Build Go binaries
        id: build_binaries
        run: |
          cd agent
          mkdir -p ../build
          
          # Build for multiple platforms
          GOOS=linux GOARCH=amd64 go build -o ../build/wirety-agent-linux-amd64 ./cmd/agent
          GOOS=linux GOARCH=arm64 go build -o ../build/wirety-agent-linux-arm64 ./cmd/agent
          GOOS=darwin GOARCH=amd64 go build -o ../build/wirety-agent-darwin-amd64 ./cmd/agent
          GOOS=darwin GOARCH=arm64 go build -o ../build/wirety-agent-darwin-arm64 ./cmd/agent
          GOOS=windows GOARCH=amd64 go build -o ../build/wirety-agent-windows-amd64.exe ./cmd/agent
          
          # Create checksums
          cd ../build
          sha256sum * > checksums.txt
          ls -lh
      
      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wirety-agent-${{ steps.vars.outputs.date }}-SNAPSHOT
          path: build/*
          retention-days: 30
      
      - name: Update comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            **Agent snapshot:**
            
            Binaries: [Download from Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - wirety-agent-linux-amd64
            - wirety-agent-linux-arm64
            - wirety-agent-darwin-amd64
            - wirety-agent-darwin-arm64
            - wirety-agent-windows-amd64.exe
            - checksums.txt
          reactions: hooray
          reactions-edit-mode: replace

  build-server:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && (github.event.comment.body == '/snapshot server' || github.event.comment.body == '/snapshot')
    steps:
      - uses: xt0rted/pull-request-comment-branch@v2
        id: comment_branch
      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.comment_branch.outputs.head_ref }}
      - run: |
          echo "date=$(date -u +'%Y-%m-%dT%H-%M-%SZ')" >> "$GITHUB_OUTPUT"
        id: vars
      - uses: actions/setup-go@v5
        with:
          go-version: '>=1.25.0'
      - uses: ko-build/setup-ko@v0.7
      - name: Build and Push Server
        id: build_server
        run: |
          echo "${{ secrets.SCW_SECRET_KEY }}" | ko login rg.fr-par.scw.cloud -u nologin --password-stdin
          cd server
          KO_DOCKER_REPO=rg.fr-par.scw.cloud/wirety/server ko publish ./cmd --bare --tags ${{ steps.vars.outputs.date }}-SNAPSHOT --platform=all
      - name: Update comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            **Server snapshot:**
            ```
            rg.fr-par.scw.cloud/wirety/server:${{ steps.vars.outputs.date }}-SNAPSHOT
            ```
          reactions: hooray
          reactions-edit-mode: replace

  build-frontend:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && (github.event.comment.body == '/snapshot front' || github.event.comment.body == '/snapshot')
    steps:
      - uses: xt0rted/pull-request-comment-branch@v2
        id: comment_branch
      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.comment_branch.outputs.head_ref }}
      - run: |
          echo "date=$(date -u +'%Y-%m-%dT%H-%M-%SZ')" >> "$GITHUB_OUTPUT"
        id: vars
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Scaleway
        uses: docker/login-action@v3
        with:
          registry: rg.fr-par.scw.cloud
          username: nologin
          password: ${{ secrets.SCW_SECRET_KEY }}
      - name: Build and Push Frontend
        id: build_frontend
        run: |
          docker build -t rg.fr-par.scw.cloud/wirety/front:${{ steps.vars.outputs.date }}-SNAPSHOT ./front
          docker push rg.fr-par.scw.cloud/wirety/front:${{ steps.vars.outputs.date }}-SNAPSHOT
      - name: Update comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            **Frontend snapshot:**
            ```
            rg.fr-par.scw.cloud/wirety/front:${{ steps.vars.outputs.date }}-SNAPSHOT
            ```
          reactions: hooray
          reactions-edit-mode: replace

  build-doc:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && (github.event.comment.body == '/snapshot doc' || github.event.comment.body == '/snapshot')
    steps:
      - uses: xt0rted/pull-request-comment-branch@v2
        id: comment_branch
      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.comment_branch.outputs.head_ref }}
      - run: |
          echo "date=$(date -u +'%Y-%m-%dT%H-%M-%SZ')" >> "$GITHUB_OUTPUT"
        id: vars
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Scaleway
        uses: docker/login-action@v3
        with:
          registry: rg.fr-par.scw.cloud
          username: nologin
          password: ${{ secrets.SCW_SECRET_KEY }}
      - name: Build and Push Documentation
        id: build_doc
        run: |
          docker build -t rg.fr-par.scw.cloud/wirety/doc:${{ steps.vars.outputs.date }}-SNAPSHOT ./doc
          docker push rg.fr-par.scw.cloud/wirety/doc:${{ steps.vars.outputs.date }}-SNAPSHOT
      - name: Update comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            **Documentation snapshot:**
            ```
            rg.fr-par.scw.cloud/wirety/doc:${{ steps.vars.outputs.date }}-SNAPSHOT
            ```
          reactions: hooray
          reactions-edit-mode: replace

    